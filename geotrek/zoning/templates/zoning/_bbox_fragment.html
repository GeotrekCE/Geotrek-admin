{% load i18n %}

<!-- begin land/bbox.html -->
{% if bbox_cities %}
    <label for="bbox_cities"></label>
    <select id="bbox_cities" class="chzn-select" style="max-width: 40%;">
        <option value="" selected>{% trans "City" %}</option>
        {% for bbox in bbox_cities %}
            <option value="{{ bbox.1|join:',' }}">{{ bbox.0 }}</option>
        {% endfor %}
    </select>
{% endif %}

{% if bbox_districts %}
    <label for="bbox_districts"></label>
    <select id="bbox_districts" class="chzn-select">
        <option value="" selected>{% trans "District" %}</option>
        {% for bbox in bbox_districts %}
            <option value="{{ bbox.1|join:',' }}">{{ bbox.0 }}</option>
        {% endfor %}
    </select>
{% endif %}

{% if bbox_areas %}
    <label for="bbox_areas"></label>
    <select id="bbox_areas" class="chzn-select">
        <option value="" selected>{% trans "Restricted Area" %}</option>
        {% for bbox in bbox_areas %}
            <option value="{{ bbox.1|join:',' }}">{{ bbox.0 }}</option>
        {% endfor %}
    </select>
{% endif %}

{% if bbox_cities or bbox_districts or bbox_areas %}
    <script type="text/javascript">
        window.addEventListener('entity:map:ready', function (event) {
            const map = event.detail.map.getMap();

            $('#bbox_cities, #bbox_districts, #bbox_areas').on('change', function () {
                const bboxval = $(this).val();

                // Clear other filters, but keep this one of course
                var self = this;
                $('#bbox_cities, #bbox_districts, #bbox_areas').each(function () {
                    if (self != this) {
                        $(this).val('');
                        $(this).removeClass('filter-set');
                    }
                });

                // Fit selected bbox, or whole map
                if (bboxval) {
                    var bbox = $.map(bboxval.split(','), parseFloat); // minx,miny,maxx,maxy
                    // MapLibre format: [[west, south], [east, north]] = [[minx, miny], [maxx, maxy]]
                    map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]]);
                    $(this).addClass('filter-set');
                } else {
                    var maxBounds = map.getMaxBounds();
                    if (maxBounds) {
                        map.fitBounds(maxBounds);
                    }
                    $(this).removeClass('filter-set');
                }
            });
        });
    </script>
{% endif %}
<!-- end land/bbox.html -->
